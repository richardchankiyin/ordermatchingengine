<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
  <head>
    <script src="jquery-1.12.4.min.js"></script>
    <script src="sockjs.min.js"></script>
    <script src="stomp.min.js"></script>
    <script src="spreadranges.js"></script>
  </head>

  <body>
  	<div id="instructionpanel" style="width: 50%; height: 50%; float:left;">
  	<p>Instruction</p>
  	<p>
  		Login: <input type="button" id="loginbutton" value="Login" />
  		Logoff: <input type="button" id="logoffbutton" value="Logoff" />
  	</p>
  	<p>
  		Place Order:
  	</p>
  	<p>
  		Symbol: <select id="symbol"><option value="0005.HK">0005.HK</option></select>
  		Side: <select id="side"><option value="1">Buy</option><option value="2">Sell</option></select>
  		Order Type: <select id="orderType"><option value="1">Market</option><option value="2">Limit</option></select>
  		Price: <input type="number" id="price" style="width: 50px;" maxlength="5" size="5" /> 
  		Quantity: <input type="number" id="quantity" style="width: 60px;" maxlength="5" size="5" min="0" pattern="\d*" /> 
  		 <input type="button" id="placeorderbutton" value="Submit" />
  	</p>
  	<p>
  	  Reply:
  	</p>
  	<p>
  		 <textarea id="notifications-area-reply" cols="95" rows="10" readonly="readonly"></textarea>
  	</p>
    <p>
	  News:
	</p>
	<textarea id="notifications-area-news" cols="95" rows="10" readonly="readonly"></textarea>
	</div>
	<div id="marketdatapanel" style="width: 50%; height: 50%; float:right;">
		<p>Market Data</p>
		<div id="bidasktable">
			<div>
				<div style="width: 20%; height: 50%; float:left;">Symbol</div>
				<div style="width: 80%; height: 50%; float:right;" id="bidasktablesymbol"></div>
			</div>		
			<div style="width: 50%; height: 50%; float:left;">
				<div style="width: 50%; height: 50%; float:left;">Bid Price:</div>
				<div style="width: 50%; height: 50%; float:right;" id="bidasktablebidprice"></div>
			</div>
			<div style="width: 50%; height: 50%; float:right;">
				<div style="width: 50%; height: 50%; float:left;">Ask Price:</div>
				<div style="width: 50%; height: 50%; float:right;" id="bidasktableaskprice"></div>
			</div>
			<div style="width: 50%; height: 50%; float:left;">
				<div style="width: 50%; height: 50%; float:left;">Bid Quantity:</div>
				<div style="width: 50%; height: 50%; float:right;" id="bidasktablebidquantity"></div>
			</div>
			<div style="width: 50%; height: 50%; float:right;">
				<div style="width: 50%; height: 50%; float:left;">Ask Quantity:</div>
				<div style="width: 50%; height: 50%; float:right;" id="bidasktableaskquantity"></div>
			</div>
		</div>
		<p>
			<div>
				<div style="width: 50%; height: 50%; float:left;"><span id="bidasktablebidprice1"></span>(<span id="bidasktablebidquantity1"></span>)</div>
				<div style="width: 50%; height: 50%; float:right;"><span id="bidasktableaskprice1"></span>(<span id="bidasktableaskquantity1"></span>)</div>
			</div>
		</p>
		<p>
			<div>
				<div style="width: 50%; height: 50%; float:left;"><span id="bidasktablebidprice2"></span>(<span id="bidasktablebidquantity2"></span>)</div>
				<div style="width: 50%; height: 50%; float:right;"><span id="bidasktableaskprice2"></span>(<span id="bidasktableaskquantity2"></span>)</div>
			</div>
		</p>
		<p>
			<div>
				<div style="width: 50%; height: 50%; float:left;"><span id="bidasktablebidprice3"></span>(<span id="bidasktablebidquantity3"></span>)</div>
				<div style="width: 50%; height: 50%; float:right;"><span id="bidasktableaskprice3"></span>(<span id="bidasktableaskquantity3"></span>)</div>
			</div>
		</p>
		<p>
			<div>
				<div style="width: 50%; height: 50%; float:left;"><span id="bidasktablebidprice4"></span>(<span id="bidasktablebidquantity4"></span>)</div>
				<div style="width: 50%; height: 50%; float:right;"><span id="bidasktableaskprice4"></span>(<span id="bidasktableaskquantity4"></span>)</div>
			</div>
		</p>
		<p>
			<div>
				<div style="width: 50%; height: 50%; float:left;"><span id="bidasktablebidprice5"></span>(<span id="bidasktablebidquantity5"></span>)</div>
				<div style="width: 50%; height: 50%; float:right;"><span id="bidasktableaskprice5"></span>(<span id="bidasktableaskquantity5"></span>)</div>
			</div>
		</p>
		<p>
			<div>
				<div style="width: 50%; height: 50%; float:left;"><span id="bidasktablebidprice6"></span>(<span id="bidasktablebidquantity6"></span>)</div>
				<div style="width: 50%; height: 50%; float:right;"><span id="bidasktableaskprice6"></span>(<span id="bidasktableaskquantity6"></span>)</div>
			</div>
		</p>
		<p>
			<div>
				<div style="width: 50%; height: 50%; float:left;"><span id="bidasktablebidprice7"></span>(<span id="bidasktablebidquantity7"></span>)</div>
				<div style="width: 50%; height: 50%; float:right;"><span id="bidasktableaskprice7"></span>(<span id="bidasktableaskquantity7"></span>)</div>
			</div>
		</p>
		<p>
			<div>
				<div style="width: 50%; height: 50%; float:left;"><span id="bidasktablebidprice8"></span>(<span id="bidasktablebidquantity8"></span>)</div>
				<div style="width: 50%; height: 50%; float:right;"><span id="bidasktableaskprice8"></span>(<span id="bidasktableaskquantity8"></span>)</div>
			</div>
		</p>
		<p>
			<div>
				<div style="width: 50%; height: 50%; float:left;"><span id="bidasktablebidprice9"></span>(<span id="bidasktablebidquantity9"></span>)</div>
				<div style="width: 50%; height: 50%; float:right;"><span id="bidasktableaskprice9"></span>(<span id="bidasktableaskquantity9"></span>)</div>
			</div>
		</p>
		<p>
			<div>
				<div style="width: 50%; height: 50%; float:left;"><span id="bidasktablebidprice10"></span>(<span id="bidasktablebidquantity10"></span>)</div>
				<div style="width: 50%; height: 50%; float:right;"><span id="bidasktableaskprice10"></span>(<span id="bidasktableaskquantity10"></span>)</div>
			</div>
		</p>
		
		<p>
      	Executions:
    	</p>
    	<textarea id="notifications-area-exec" cols="95" rows="10" readonly="readonly"></textarea>
	
	</div>
    <!-- Javascript functions -->
    <script>
    		
      /**
       * Open the web socket connection and subscribe the "/notify" channel.
       */
      function connect() {

        // Create and init the SockJS object
        var socket = new SockJS('http://localhost:18888/ws');
        var stompClient = Stomp.over(socket);

        // Subscribe the '/notify' channel
        stompClient.connect({}, function(frame) {
          stompClient.subscribe('/topic/executionreport/notify', function(notification) {
			//console.log(notification.body);
			var msgtype = JSON.parse(notification.body)["35"];
            // Call the notify function when receive a notification
            if (msgtype == '8') {
            	notifyexecution(JSON.stringify(notification.body));
            }
			if (msgtype == 'B') {
				notifynews(JSON.stringify(notification.body));
				processnews(notification.body);
			}
          });
        });
        
        return;
      } // function connect
      
      function processnews(messageobj) {
    	  var msgobjparsed = JSON.parse(messageobj);
    	  var title = msgobjparsed["148"];
    	  
    	  if (title.startsWith("OrderBook Price")) {
    		  if (msgobjparsed["54"] == "1") {
    			  $("#bidasktablebidprice").text(msgobjparsed["44"]);
    			  updatebidprices(com.richardchankiyin.spreadcalc.SpreadRanges.getInstance().getSpreadPrices(msgobjparsed["44"],false,10));
    		  }
    		  if (msgobjparsed["54"] == "2") {
    			  $("#bidasktableaskprice").text(msgobjparsed["44"]);
    			  updateaskprices(com.richardchankiyin.spreadcalc.SpreadRanges.getInstance().getSpreadPrices(msgobjparsed["44"],true,10));
    		  }
    	  }
    	  
    	  if (title.startsWith("OrderBook Quantity")) {
    		  if (msgobjparsed["54"] == "1") {
    			  $("#bidasktablebidquantity").text(msgobjparsed["38"]);
    		  }
    		  if (msgobjparsed["54"] == "2") {
    			  $("#bidasktableaskquantity").text(msgobjparsed["38"]);
    		  }
    	  }
      }
      
      function updatebidprices(input) {
    	  $("#bidasktablebidprice1").text(input[0]);
    	  $("#bidasktablebidprice2").text(input[1]);
    	  $("#bidasktablebidprice3").text(input[2]);
    	  $("#bidasktablebidprice4").text(input[3]);
    	  $("#bidasktablebidprice5").text(input[4]);
    	  $("#bidasktablebidprice6").text(input[5]);
    	  $("#bidasktablebidprice7").text(input[6]);
    	  $("#bidasktablebidprice8").text(input[7]);
    	  $("#bidasktablebidprice9").text(input[8]);
    	  $("#bidasktablebidprice10").text(input[9]);
      }
      
      function updateaskprices(input) {
    	  $("#bidasktableaskprice1").text(input[0]);
    	  $("#bidasktableaskprice2").text(input[1]);
    	  $("#bidasktableaskprice3").text(input[2]);
    	  $("#bidasktableaskprice4").text(input[3]);
    	  $("#bidasktableaskprice5").text(input[4]);
    	  $("#bidasktableaskprice6").text(input[5]);
    	  $("#bidasktableaskprice7").text(input[6]);
    	  $("#bidasktableaskprice8").text(input[7]);
    	  $("#bidasktableaskprice9").text(input[8]);
    	  $("#bidasktableaskprice10").text(input[9]);
      }
      
      /**
       * Display the notification message.
       */
      function notifyexecution(message) {
        $("#notifications-area-exec").prepend(message + "\n");
        return;
      }
      function notifynews(message) {
        $("#notifications-area-news").prepend(message + "\n");
        return;
      }
      function notifyreply(message) {
    	$("#notifications-area-reply").prepend(message + "\n");
        return;
    	  
      }
      
      /**
       * Init operations.
       */
      $(document).ready(function() {
        
        // Start the web socket connection.
        connect();
        // init symbol
        $.get("http://localhost:18888/symbol", function(data, status){
        	$("#bidasktablesymbol").text(data);
       	});

        
		// login button        
        $("#loginbutton").click(function(){
      	  $.get("http://localhost:18888/login", function(data, status){
      		notifyreply("login -- [Data: " + data + "|Status: " + status + "]");
      	  });
      	});
		
		// logout button
        $("#logoffbutton").click(function(){
        	$.get("http://localhost:18888/logoff", function(data, status){
        		notifyreply("logout -- [Data: " + data + "|Status: " + status + "]");
        	});
        });
		
		// placeorder button
		$("#placeorderbutton").click(function() {
			var symbol = $("#symbol").children("option:selected").val();
			var side = $("#side").children("option:selected").val();
			var orderType = $("#orderType").children("option:selected").val();
			var price = $("#price").val();
			var quantity = $("#quantity").val();
			
			if (orderType == "2") {
				var request = $.ajax({
					method: "POST",
					url:"http://localhost:18888/order",
					contentType:"application/json",
					data: "{ \"symbol\": \"" + symbol + "\", \"side\": \"" + side + "\", \"ordType\": \"" + orderType + "\", \"price\":" + price + ", \"quantity\":" + quantity + "}"
				});
				
				request.done(function( msg ) {
					notifyreply("placeorder -- " + msg);
				});
					 
				request.fail(function( jqXHR, textStatus ) {
					notifyreply("placeorder -- " + textStatus);
				});				
			} else {
				var request = $.ajax({
					method: "POST",
					url:"http://localhost:18888/order",
					contentType:"application/json",
					data: "{ \"symbol\": \"" + symbol + "\", \"side\": \"" + side + "\", \"ordType\": \"" + orderType + "\", \"quantity\":" + quantity + "}"
				});
				
				request.done(function( msg ) {
					notifyreply("placeorder -- " + msg);
				});
					 
				request.fail(function( jqXHR, textStatus ) {
					notifyreply("placeorder -- " + textStatus);
				});	
				
			}
			
			
		});
      });

    </script>

    <br />
    <hr />

  </body>

</html>
